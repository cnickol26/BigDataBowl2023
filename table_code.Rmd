---
title: "BDB Plots"
author: 'Connor Nickol, email: can2hr@virginia.edu'
date: "2023-01-05"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
runtime: shiny    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
library(shiny)
library(shinythemes)
```

## Looking at Speed
```{r}
speed_coef <- read_csv('speed_coeff.csv')
logos <- read_csv('logos.csv')

speed_coef$mean_scaled <- scale(speed_coef$mean)[,1]

speed_coef_filt <- speed_coef %>% left_join(logos) %>% select(tackle_name, link,team, n, mean_scaled, sd) %>% mutate(mean_scaled = round(mean_scaled, 3),sd = round(sd,3),Ranking = rank(-mean_scaled, ties.method = 'first')) %>% 
  rename(`Speed Coefficient` = mean_scaled, `Speed Coefficient SD` = sd, `Number of Speed Rushes Faced` = n, ` ` = link, Player = tackle_name, Team = team)

```
## Looking at Power
```{r}
power_coef <- read_csv("power_coeff.csv")

power_coef$mean_scaled <- scale(power_coef$mean)[,1]
power_coef_filt <- power_coef %>% left_join(logos) %>% select(tackle_name, link,team, n, mean_scaled, sd) %>% mutate(mean_scaled = round(mean_scaled, 3),sd = round(sd,3),Ranking = rank(-mean_scaled, ties.method = 'first')) %>% 
  rename(`Power Coefficient` = mean_scaled, `Power Coefficient SD` = sd, `Number of Power Rushes Faced` = n, ` ` = link, Player = tackle_name, Team = team)

```

## Looking at full rankings
```{r}
power_coef_full <- power_coef %>% select(tackle_name,team,mean_scaled,n) %>% 
  rename(power_mean_scaled = mean_scaled, num_power = n)

speed_coef_full <- speed_coef %>% select(tackle_name,team,mean_scaled,n) %>% 
  rename(speed_mean_scaled = mean_scaled, num_speed = n)

full_data <- full_join(power_coef_full, speed_coef_full, by=c("tackle_name", "team")) %>% na.omit()

full_data2 <- full_data %>% mutate(equal_weight = round((power_mean_scaled + speed_mean_scaled)/2,3),percent_weight = round(((power_mean_scaled)*.79 + (speed_mean_scaled)*.21)/2,3)) %>% select(-c(power_mean_scaled,speed_mean_scaled))

full_data3 <- full_data2 %>% mutate(equal_rank = rank(-equal_weight,ties.method = 'first'),
                                  percent_rank = rank(-percent_weight, ties.method = 'first'),
                                  rushes_faced = num_power+num_speed)

full_data4 <- full_data3 %>% left_join(logos)

full_data4 <- full_data4 %>% select(tackle_name, link, team, rushes_faced,
                                    equal_weight, equal_rank, percent_weight, percent_rank)

full_data4 <- full_data4 %>% rename(Player = tackle_name, `            ` = link, Team = team,
                                    `Total Rushes Faced` = rushes_faced, 
                                    `Mean Coefficient (Equal Weight)` = equal_weight,
                                    `Equal Weight Ranking` = equal_rank, 
                                    `Mean Coefficient (Weighted by S:P Ratio)` = percent_weight,
                                    `Ratio Ranking` = percent_rank)

```

```{r}
## Colour and values for table colour formatting
breaks <- seq(-3, 2.3, by = .25)
colors <- colorRampPalette(c("#F80505", "#3ACA2A"))(length(breaks) + 1)

ui <- navbarPage(title = "Modeling Results", theme = shinytheme("spacelab"),
      tabPanel("Full Rankings", DT::dataTableOutput("full_table")), 
      tabPanel("Speed Only",DT::dataTableOutput("speed_table")), 
      tabPanel("Power Only", DT::dataTableOutput("power_table"))
      )

server = function(input, output){
    output$full_table <-DT::renderDT({datatable(full_data4,
          options = list(scrollX = TRUE,
                         scrollY = TRUE,
                         server = FALSE,
                         columnDefs = list(list(className = 'dt-center',width = '500px',targets = '_all'))),
          escape = FALSE,
          rownames = FALSE) %>% 
        formatStyle(columns = c('Player', 'Team', 'Total Rushes Faced', 'Equal Weight Ranking',
                                'Ratio Ranking'), fontWeight = 'bold') %>% 
      formatStyle(c('Mean Coefficient (Equal Weight)', 'Mean Coefficient (Weighted by S:P Ratio)'), backgroundColor = styleInterval(breaks, colors), color = 'white',fontWeight = 'bold' )})

    
    output$speed_table <- DT::renderDT({datatable(speed_coef_filt,
          options = list(scrollX = TRUE,
                         scrollY = TRUE,
                         server = FALSE,
                         columnDefs = list(list(className = 'dt-center',width = '500px' ,targets = '_all'))),
          escape = FALSE,
          rownames = FALSE) %>% 
        formatStyle(columns = c('Player', 'Team', 'Number of Speed Rushes Faced', 
                                'Ranking', 'Speed Coefficient SD'), fontWeight = 'bold') %>% 
      formatStyle(c('Speed Coefficient'), backgroundColor = styleInterval(breaks, colors),
                  color = 'white',fontWeight = 'bold' )})

    
    output$power_table <- DT::renderDT({datatable(power_coef_filt,
          options = list(scrollX = TRUE,
                         scrollY = TRUE,
                         server = FALSE,
                         columnDefs = list(list(className = 'dt-center',width = '500px' ,targets = '_all'))),
          escape = FALSE,
          rownames = FALSE) %>% 
        formatStyle(columns = c('Player', 'Team', 'Number of Power Rushes Faced', 
                                'Ranking', 'Power Coefficient SD'), fontWeight = 'bold') %>% 
      formatStyle(c('Power Coefficient'), backgroundColor = styleInterval(breaks, colors),
                  color = 'white',fontWeight = 'bold' )})
    }

shinyApp(ui = ui, server = server, options = list(height = 1000))
```



